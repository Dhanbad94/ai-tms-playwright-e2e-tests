<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>JSDoc: Source: consumer-login.js</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link
      type="text/css"
      rel="stylesheet"
      href="styles/prettify-tomorrow.css"
    />
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css" />
  </head>

  <body>
    <div id="main">
      <h1 class="page-title">Source: consumer-login.js</h1>

      <section>
        <article>
          <pre
            class="prettyprint source linenums"
          ><code>/* eslint-disable prefer-template */
import axios from 'axios';

// eslint-disable-next-line import/no-extraneous-dependencies
const crypto = require('crypto');

/**
 * @returns {Integer} timestamp
 */
function getTimestamp() {
  return Math.floor(new Date().getTime() / 1000);
}

/**
 * @returns {Integer} arbitrary number
 */
function getNonce() {
  return Math.random().toString(36).substr(2, 11);
}

/**
 * @param {string} consumerKey - consumer key
 * @param {*} oauthSignatureMethod -Oauth signature method
 * @param {*} oauthNonce - arbitrary number
 * @param {*} oauthTimestamp - Oauth timestamp
 * @returns {string} - timestamp that will be used in generating HMAC
 */
function getBaseTimestamp(
  consumerKey,
  oauthSignatureMethod,
  oauthNonce,
  oauthTimestamp,
) {
  return `&amp;${encodeURIComponent(
    `oauth_consumer_key=${consumerKey}&amp;oauth_nonce=${oauthNonce}&amp;oauth_signature_method=${oauthSignatureMethod}&amp;oauth_timestamp=${oauthTimestamp}`,
  )}`;
}

/**
 * @param {string} oauthVersion .
 * @returns {*} - encoded Oauth version
 */
function getBaseVersion(oauthVersion) {
  return encodeURIComponent(`&amp;oauth_version=${oauthVersion}`);
}

/**
 * @param {string} consumerSecret -
 * @param {URL} requestEndpoint -
 * @param {Integer} baseTimestamp -
 * @param {*} baseVersion -encoded Oauth version
 * @returns {*} - signature for request
 */
function getOauthSignature(
  consumerSecret,
  requestEndpoint,
  baseTimestamp,
  baseVersion,
) {
  const hmac = crypto.createHmac('sha1', `${consumerSecret}&amp;`);
  hmac.update(
    `POST&amp;${encodeURIComponent(requestEndpoint)}${baseTimestamp}${baseVersion}`,
  );
  return hmac.digest('base64');
}

/**
 * @param {*} consumerKey -
 * @param {*} oauthSignatureMethod -
 * @param {*} oauthTimestamp -
 * @param {*} oauthNonce -
 * @param {*} oauthVersion -
 * @returns {string} - header
 */
function getOauthHeader(
  consumerKey,
  oauthSignatureMethod,
  oauthTimestamp,
  oauthNonce,
  oauthVersion,
) {
  return `OAuth oauth_consumer_key="${consumerKey}",oauth_signature_method="${oauthSignatureMethod}",oauth_timestamp="${oauthTimestamp}",oauth_nonce="${oauthNonce}",oauth_version="${oauthVersion}",oauth_signature="`;
}

/**
 * @param {JSON} config - consumer login request config
 * @return {Promise&lt;JSON>} - returns either token and/or status code
 */
export async function getToken(config) {
  const { requestEndpoint, consumerKey, consumerSecret } = config;
  const oauthSignatureMethod = 'HMAC-SHA1';
  const oauthTimestamp = getTimestamp();
  const oauthNonce = getNonce();
  const oauthVersion = '1.0';
  const baseTimestamp = getBaseTimestamp(
    consumerKey,
    oauthSignatureMethod,
    oauthNonce,
    oauthTimestamp,
  );
  const baseVersion = getBaseVersion(oauthVersion);
  const oauthSignature = getOauthSignature(
    consumerSecret,
    requestEndpoint,
    baseTimestamp,
    baseVersion,
  );
  const oauthHeader = getOauthHeader(
    consumerKey,
    oauthSignatureMethod,
    oauthTimestamp,
    oauthNonce,
    oauthVersion,
  );

  const data = JSON.stringify({
    key: consumerKey,
    secret: consumerSecret,
  });

  const options = {
    method: 'POST',
    url: requestEndpoint,
    headers: {
      'Content-Type': 'application/vnd.io.ai.credentials.consumer-key+json',
      Authorization: `${oauthHeader + oauthSignature}"`,
    },
    data,
  };

  try {
    const response = await axios(options);
    return {
      token: response.data['access-token'],
      status: response.status,
    };
  } catch (error) {
    return {
      status: error.response.status,
      data: error.response.data,
    };
  };
}

/**
 * @param {JSON} config - consumer login request config
 * @return {Promise&lt;JSON>} - returns either token and/or status code
 */
export async function loginWithRealm(config) {
  const { requestEndpoint, consumerKey, consumerSecret, realm } = config;
  const oauthSignatureMethod = 'HMAC-SHA1';
  const oauthTimestamp = getTimestamp();
  const oauthNonce = getNonce();
  const oauthVersion = '1.0';
  const baseTimestamp = getBaseTimestamp(
    consumerKey,
    oauthSignatureMethod,
    oauthNonce,
    oauthTimestamp,
  );
  const baseVersion = getBaseVersion(oauthVersion);
  const oauthSignature = getOauthSignature(
    consumerSecret,
    requestEndpoint,
    baseTimestamp,
    baseVersion,
  );
  const oauthHeader = getOauthHeader(
    consumerKey,
    oauthSignatureMethod,
    oauthTimestamp,
    oauthNonce,
    oauthVersion,
  );

  const data = JSON.stringify({
    key: consumerKey,
    secret: consumerSecret,
    realm,
  });

  const options = {
    method: 'POST',
    url: requestEndpoint,
    headers: {
      'Content-Type': 'application/vnd.io.ai.credentials.consumer-key+json',
      Authorization: `${oauthHeader + oauthSignature}"`,
    },
    data,
  };

  try {
    const response = await axios(options);
    return {
      token: response.data['access-token'],
      status: response.status,
    };
  } catch (error) {
    return {
      status: error.response.status,
      data: error.response.data,
    };
  }
}

/**
 * @param {JSON} config - consumer login request config
 * @param {JSON} credentials - username &amp; password
 * @return {Promise&lt;JSON>} - returns either token and/or status code
 */
export async function loginWithUP(config, credentials) {
  const { requestEndpoint, consumerKey, consumerSecret } = config;
  const { username, password, realm } = credentials;
  const oauthSignatureMethod = 'HMAC-SHA1';
  const oauthTimestamp = getTimestamp();
  const oauthNonce = getNonce();
  const oauthVersion = '1.0';
  const baseTimestamp = getBaseTimestamp(
    consumerKey,
    oauthSignatureMethod,
    oauthNonce,
    oauthTimestamp,
  );
  const baseVersion = getBaseVersion(oauthVersion);
  const oauthSignature = getOauthSignature(
    consumerSecret,
    requestEndpoint,
    baseTimestamp,
    baseVersion,
  );
  const oauthHeader = getOauthHeader(
    consumerKey,
    oauthSignatureMethod,
    oauthTimestamp,
    oauthNonce,
    oauthVersion,
  );

  let data;
  if (realm === 'undefined') {
    data = JSON.stringify({
      username,
      password,
    });
  } else {
    data = JSON.stringify({
      username,
      password,
      realm,
    });
  }

  const options = {
    method: 'POST',
    url: requestEndpoint,
    headers: {
      'Content-Type':
        'application/vnd.io.ai.credentials.username-password+json',
      Authorization: `${oauthHeader + oauthSignature}"`,
    },
    data,
  };

  const response = await axios(options).catch(function message(error) {
    console.log(error);
  });
  const token = response.data['access-token'];
  const statusCode = response.status;
  return {
    token,
    statusCode,
  };
}

/**
 * @param {JSON} config - consumer login request config
 * @return {Promise&lt;JSON>} - returns either token and/or status code
 */
export async function getTokenForSubRealm(config) {
  const { requestEndpoint, consumerKey, consumerSecret, realm } = config;
  const oauthSignatureMethod = 'HMAC-SHA1';
  const oauthTimestamp = getTimestamp();
  const oauthNonce = getNonce();
  const oauthVersion = '1.0';
  const baseTimestamp = getBaseTimestamp(
    consumerKey,
    oauthSignatureMethod,
    oauthNonce,
    oauthTimestamp,
  );
  const baseVersion = getBaseVersion(oauthVersion);
  const oauthSignature = getOauthSignature(
    consumerSecret,
    requestEndpoint,
    baseTimestamp,
    baseVersion,
  );
  const oauthHeader = getOauthHeader(
    consumerKey,
    oauthSignatureMethod,
    oauthTimestamp,
    oauthNonce,
    oauthVersion,
  );

  const data = JSON.stringify({
    key: consumerKey,
    secret: consumerSecret,
    realm,
  });

  const options = {
    method: 'POST',
    url: requestEndpoint,
    headers: {
      'Content-Type': 'application/vnd.io.ai.credentials.consumer-key+json',
      Authorization: `${oauthHeader + oauthSignature}"`,
    },
    data,
  };
  try {
    const response = await axios(options);
    return {
      token: response.data['access-token'],
      status: response.status,
    };
  } catch (error) {
    return {
      status: error.response.status,
      data: error.response.data,
    };
  }
}

/**
 * @param {JSON} config - config contains consumer secrets &amp; endpoint
 * @param {string} token - Auth token
 * @returns {string} - modified authorization token for the header of the request
 */
export function getAuthHeader(config, token) {
  const { requestEndpoint, consumerKey, consumerSecret, method } = config;
  const oauthSignatureMethod = 'HMAC-SHA1';
  const oauthTimestamp = Math.floor(new Date().getTime() / 1000);
  const oauthNonce = Math.random().toString(36).substr(2, 11);
  const oauthVersion = '1.0';
  const baseTimestamp =
    '&amp;' +
    encodeURIComponent(
      'oauth_consumer_key=' +
        consumerKey +
        '&amp;oauth_nonce=' +
        oauthNonce +
        '&amp;oauth_signature_method=' +
        oauthSignatureMethod +
        '&amp;oauth_timestamp=' +
        oauthTimestamp,
    );
  const baseVersion = encodeURIComponent('&amp;oauth_version=' + oauthVersion);
  const oauthHeader =
    'OAuth oauth_consumer_key="' +
    consumerKey +
    '",oauth_signature_method="' +
    oauthSignatureMethod +
    '",oauth_timestamp="' +
    oauthTimestamp +
    '",oauth_nonce="' +
    oauthNonce +
    '",oauth_version="' +
    oauthVersion +
    '",oauth_signature="';
  const baseToken = encodeURIComponent('&amp;oauth_token=' + token);
  const hmac = crypto.createHmac('sha1', `${consumerSecret}&amp;`);
  hmac.update(
    `${method}&amp;${encodeURIComponent(
      requestEndpoint,
    )}${baseTimestamp}${baseToken}${baseVersion}`,
  );
  const signature = hmac.digest('base64');

  return oauthHeader + signature + '",oauth_token="' + token + '"';
}
</code></pre>
        </article>
      </section>
    </div>

    <nav>
      <h2><a href="index.html">Home</a></h2>
      <h3>Global</h3>
      <ul>
        <li>
          <a href="global.html#checkMatchingTestRuns">checkMatchingTestRuns</a>
        </li>
        <li>
          <a href="global.html#combineParallelSequentialFiles"
            >combineParallelSequentialFiles</a
          >
        </li>
        <li>
          <a href="global.html#concatenateTestResults"
            >concatenateTestResults</a
          >
        </li>
        <li><a href="global.html#convertJSON2Txt">convertJSON2Txt</a></li>
        <li><a href="global.html#createAsset">createAsset</a></li>
        <li>
          <a href="global.html#createPipelinePayload">createPipelinePayload</a>
        </li>
        <li>
          <a href="global.html#createProofworkPayload"
            >createProofworkPayload</a
          >
        </li>
        <li>
          <a href="global.html#createTemplateTestPayload"
            >createTemplateTestPayload</a
          >
        </li>
        <li><a href="global.html#extractBrowser">extractBrowser</a></li>
        <li><a href="global.html#findShortcut">findShortcut</a></li>
        <li><a href="global.html#findUserProd">findUserProd</a></li>
        <li><a href="global.html#getAllFiles">getAllFiles</a></li>
        <li><a href="global.html#getAuthHeader">getAuthHeader</a></li>
        <li><a href="global.html#getBaseTimestamp">getBaseTimestamp</a></li>
        <li><a href="global.html#getBaseVersion">getBaseVersion</a></li>
        <li><a href="global.html#getDropdownOption">getDropdownOption</a></li>
        <li><a href="global.html#loginWithRealm">loginWithRealm</a></li>
        <li><a href="global.html#getNonce">getNonce</a></li>
        <li><a href="global.html#getOauthHeader">getOauthHeader</a></li>
        <li><a href="global.html#getOauthSignature">getOauthSignature</a></li>
        <li>
          <a href="global.html#getRandomCapitalString"
            >getRandomCapitalString</a
          >
        </li>
        <li>
          <a href="global.html#getRandomLowerCaseString"
            >getRandomLowerCaseString</a
          >
        </li>
        <li><a href="global.html#getRandomString">getRandomString</a></li>
        <li><a href="global.html#getSpanOption">getSpanOption</a></li>
        <li><a href="global.html#getTimestamp">getTimestamp</a></li>
        <li><a href="global.html#getToken">getToken</a></li>
        <li>
          <a href="global.html#getTokenForSubRealm">getTokenForSubRealm</a>
        </li>
        <li>
          <a href="global.html#getUserCredentialsUsingKey"
            >getUserCredentialsUsingKey</a
          >
        </li>
        <li><a href="global.html#getValidUserList">getValidUserList</a></li>
        <li><a href="global.html#loginWithRealm">loginWithRealm</a></li>
        <li><a href="global.html#loginWithUP">loginWithUP</a></li>
        <li>
          <a href="global.html#proofworksLibraryConfigureDelete"
            >proofworksLibraryConfigureDelete</a
          >
        </li>
        <li>
          <a href="global.html#proofworksLibraryConfigureEdit"
            >proofworksLibraryConfigureEdit</a
          >
        </li>
        <li><a href="global.html#randomItem">randomItem</a></li>
        <li><a href="global.html#setLaunchURL">setLaunchURL</a></li>
        <li><a href="global.html#setSkipTests">setSkipTests</a></li>
        <li><a href="global.html#setUserCredentials">setUserCredentials</a></li>
        <li><a href="global.html#updateBaseURL">updateBaseURL</a></li>
        <li><a href="global.html#updateXMLFiles">updateXMLFiles</a></li>
      </ul>
    </nav>

    <br class="clear" />

    <footer>
      Documentation generated by
      <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.10</a> on Tue Feb 01
      2022 12:21:02 GMT-0500 (Eastern Standard Time)
    </footer>

    <script>
      prettyPrint();
    </script>
    <script src="scripts/linenumber.js"></script>
  </body>
</html>
