name: Scheduled Tests - Staging

# Schedule:
# - Daily smoke tests Mon-Fri at 6:00 AM UTC
# - Regression tests Tue, Thu at 8:00 AM UTC

on:
  schedule:
    # Daily smoke tests Monday-Friday at 6:00 AM UTC
    - cron: '0 6 * * 1-5'
    # Regression tests Tuesday and Thursday at 8:00 AM UTC
    - cron: '0 8 * * 2,4'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Test type to run'
        required: true
        default: 'smoke'
        type: choice
        options:
          - smoke
          - regression
          - critical
          - all
      test_suite:
        description: 'Test suite to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - ASAPSettings
          - TMSOnboarding

env:
  ENV: staging
  BASE_URL: https://staging.trackmyshuttle.com

jobs:
  # Check if secrets are configured
  check-secrets:
    name: Verify Staging Secrets
    runs-on: ubuntu-latest
    outputs:
      secrets_configured: ${{ steps.check.outputs.configured }}
      slack_configured: ${{ steps.check.outputs.slack }}
    steps:
      - name: Check if staging secrets exist
        id: check
        run: |
          if [ -n "${{ secrets.STAGING_MANAGER_EMAIL }}" ] && [ -n "${{ secrets.STAGING_MANAGER_PASSWORD }}" ]; then
            echo "configured=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Staging secrets are configured"
          else
            echo "configured=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Staging secrets not configured - skipping tests"
          fi

          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            echo "slack=true" >> $GITHUB_OUTPUT
          else
            echo "slack=false" >> $GITHUB_OUTPUT
          fi

  staging-tests:
    name: Staging ${{ github.event.inputs.test_type || 'Scheduled' }} Tests
    runs-on: ubuntu-latest
    needs: check-secrets
    if: needs.check-secrets.outputs.secrets_configured == 'true'
    timeout-minutes: 60
    outputs:
      test_type: ${{ steps.test-config.outputs.test_type }}
      test_suite: ${{ steps.test-config.outputs.test_suite }}
      test_result: ${{ steps.test-result.outputs.result }}
      total_tests: ${{ steps.test-result.outputs.total }}
      passed_tests: ${{ steps.test-result.outputs.passed }}
      failed_tests: ${{ steps.test-result.outputs.failed }}
      duration: ${{ steps.test-result.outputs.duration }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Create .env.local from secrets
        run: |
          echo "STAGING_MANAGER_EMAIL=${{ secrets.STAGING_MANAGER_EMAIL }}" > .env.local
          echo "STAGING_MANAGER_PASSWORD=${{ secrets.STAGING_MANAGER_PASSWORD }}" >> .env.local
          echo "STAGING_OPERATOR_EMAIL=${{ secrets.STAGING_OPERATOR_EMAIL }}" >> .env.local
          echo "STAGING_OPERATOR_PASSWORD=${{ secrets.STAGING_OPERATOR_PASSWORD }}" >> .env.local
          echo "Created .env.local with contents:"
          cat .env.local | sed 's/=.*/=***/'

      - name: Determine test type
        id: test-config
        run: |
          # Check if this is a manual trigger or scheduled
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TEST_TYPE="${{ github.event.inputs.test_type }}"
            TEST_SUITE="${{ github.event.inputs.test_suite }}"
          else
            # Determine based on cron schedule
            HOUR=$(date -u +%H)
            DAY=$(date -u +%u)

            if [ "$HOUR" == "08" ] && ([ "$DAY" == "2" ] || [ "$DAY" == "4" ]); then
              TEST_TYPE="regression"
            else
              TEST_TYPE="smoke"
            fi
            TEST_SUITE="all"
          fi

          echo "test_type=$TEST_TYPE" >> $GITHUB_OUTPUT
          echo "test_suite=$TEST_SUITE" >> $GITHUB_OUTPUT
          echo "üìã Test Type: $TEST_TYPE"
          echo "üìÅ Test Suite: $TEST_SUITE"

      - name: Run Playwright tests
        id: run-tests
        run: |
          TEST_TYPE="${{ steps.test-config.outputs.test_type }}"
          TEST_SUITE="${{ steps.test-config.outputs.test_suite }}"

          # Build the test command
          CMD="npx playwright test --project=chromium"

          # Add grep filter for test type
          if [ "$TEST_TYPE" != "all" ]; then
            CMD="$CMD --grep @$TEST_TYPE"
          fi

          # Add test suite filter
          if [ "$TEST_SUITE" != "all" ]; then
            CMD="$CMD tests/$TEST_SUITE/"
          fi

          echo "Running: $CMD"
          START_TIME=$(date +%s)

          # Run tests and capture exit code
          set +e
          eval $CMD
          EXIT_CODE=$?
          set -e

          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "duration=$DURATION" >> $GITHUB_OUTPUT
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT

          exit $EXIT_CODE
        env:
          CI: true
          ENV: staging
          BASE_URL: https://staging.trackmyshuttle.com

      - name: Parse test results
        id: test-result
        if: always()
        run: |
          if [ -f "test-results.json" ]; then
            # Parse JSON results
            TOTAL=$(jq '.stats.expected + .stats.unexpected + .stats.flaky // 0' test-results.json 2>/dev/null || echo "0")
            PASSED=$(jq '.stats.expected // 0' test-results.json 2>/dev/null || echo "0")
            FAILED=$(jq '.stats.unexpected // 0' test-results.json 2>/dev/null || echo "0")
            FLAKY=$(jq '.stats.flaky // 0' test-results.json 2>/dev/null || echo "0")
            DURATION=$(jq '.stats.duration // 0' test-results.json 2>/dev/null || echo "0")
            DURATION_SEC=$((DURATION / 1000))
          else
            TOTAL="N/A"
            PASSED="N/A"
            FAILED="N/A"
            FLAKY="0"
            DURATION_SEC="${{ steps.run-tests.outputs.duration }}"
          fi

          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "flaky=$FLAKY" >> $GITHUB_OUTPUT
          echo "duration=${DURATION_SEC}s" >> $GITHUB_OUTPUT

          if [ "${{ steps.run-tests.outputs.exit_code }}" == "0" ]; then
            echo "result=passed" >> $GITHUB_OUTPUT
          else
            echo "result=failed" >> $GITHUB_OUTPUT
          fi

      - name: Upload test report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: staging-report-${{ steps.test-config.outputs.test_type }}-${{ github.run_number }}
          path: playwright-report/
          retention-days: 30

      - name: Upload failure artifacts
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: staging-failures-${{ github.run_number }}
          path: test-results/
          retention-days: 7

  # Unified notification job for both success and failure
  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: [check-secrets, staging-tests]
    if: always() && needs.check-secrets.outputs.secrets_configured == 'true' && needs.check-secrets.outputs.slack_configured == 'true'
    steps:
      - name: Send Slack notification
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          # Determine status and emoji
          RESULT="${{ needs.staging-tests.result }}"
          TEST_TYPE="${{ needs.staging-tests.outputs.test_type }}"
          TEST_SUITE="${{ needs.staging-tests.outputs.test_suite }}"
          TOTAL="${{ needs.staging-tests.outputs.total_tests }}"
          PASSED="${{ needs.staging-tests.outputs.passed_tests }}"
          FAILED="${{ needs.staging-tests.outputs.failed_tests }}"
          DURATION="${{ needs.staging-tests.outputs.duration }}"

          if [ "$RESULT" == "success" ]; then
            EMOJI="‚úÖ"
            COLOR="#36a64f"
            STATUS="Passed"
            HEADER="Staging Tests Passed"
          else
            EMOJI="‚ùå"
            COLOR="#dc3545"
            STATUS="Failed"
            HEADER="Staging Tests Failed"
          fi

          # Build the message
          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"attachments\": [
                {
                  \"color\": \"$COLOR\",
                  \"blocks\": [
                    {
                      \"type\": \"header\",
                      \"text\": {
                        \"type\": \"plain_text\",
                        \"text\": \"$EMOJI $HEADER\",
                        \"emoji\": true
                      }
                    },
                    {
                      \"type\": \"section\",
                      \"fields\": [
                        {
                          \"type\": \"mrkdwn\",
                          \"text\": \"*Environment:*\nStaging\"
                        },
                        {
                          \"type\": \"mrkdwn\",
                          \"text\": \"*Test Type:*\n${TEST_TYPE}\"
                        },
                        {
                          \"type\": \"mrkdwn\",
                          \"text\": \"*Total Tests:*\n${TOTAL}\"
                        },
                        {
                          \"type\": \"mrkdwn\",
                          \"text\": \"*Passed:*\n${PASSED}\"
                        },
                        {
                          \"type\": \"mrkdwn\",
                          \"text\": \"*Failed:*\n${FAILED}\"
                        },
                        {
                          \"type\": \"mrkdwn\",
                          \"text\": \"*Duration:*\n${DURATION}\"
                        }
                      ]
                    },
                    {
                      \"type\": \"section\",
                      \"text\": {
                        \"type\": \"mrkdwn\",
                        \"text\": \"*Repository:* ${{ github.repository }}\n*Branch:* ${{ github.ref_name }}\"
                      }
                    },
                    {
                      \"type\": \"actions\",
                      \"elements\": [
                        {
                          \"type\": \"button\",
                          \"text\": {
                            \"type\": \"plain_text\",
                            \"text\": \"View Results\",
                            \"emoji\": true
                          },
                          \"url\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"
                        }
                      ]
                    }
                  ]
                }
              ]
            }" \
            $SLACK_WEBHOOK_URL
        continue-on-error: true

  # Skip notification when secrets not configured
  notify-skipped:
    name: Notify Skipped
    runs-on: ubuntu-latest
    needs: check-secrets
    if: needs.check-secrets.outputs.secrets_configured == 'false'
    steps:
      - name: Log skip reason
        run: |
          echo "‚è≠Ô∏è Staging tests skipped - secrets not configured"