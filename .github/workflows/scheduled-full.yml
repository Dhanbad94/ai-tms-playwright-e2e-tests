name: Scheduled Tests - Full Suite (Multi-Browser)

# Schedule:
# - Saturday at 5:00 AM UTC - Comprehensive multi-browser run on staging

on:
  schedule:
    # Saturday at 5:00 AM UTC
    - cron: '0 5 * * 6'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - preproduction
      browsers:
        description: 'Browsers to test'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - chromium
          - firefox
          - webkit
      test_suite:
        description: 'Test suite to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - ASAPSettings
          - TMSOnboarding

jobs:
  # Check if secrets are configured
  check-secrets:
    name: Verify Secrets
    runs-on: ubuntu-latest
    outputs:
      staging_configured: ${{ steps.check.outputs.staging }}
      preprod_configured: ${{ steps.check.outputs.preprod }}
    steps:
      - name: Check secrets
        id: check
        run: |
          # Check staging
          if [ -n "${{ secrets.STAGING_MANAGER_EMAIL }}" ]; then
            echo "staging=true" >> $GITHUB_OUTPUT
          else
            echo "staging=false" >> $GITHUB_OUTPUT
          fi

          # Check preproduction
          if [ -n "${{ secrets.PREPROD_MANAGER_EMAIL }}" ]; then
            echo "preprod=true" >> $GITHUB_OUTPUT
          else
            echo "preprod=false" >> $GITHUB_OUTPUT
          fi

  # Determine which environment to use
  setup:
    name: Setup Test Configuration
    runs-on: ubuntu-latest
    needs: check-secrets
    outputs:
      environment: ${{ steps.config.outputs.environment }}
      base_url: ${{ steps.config.outputs.base_url }}
      browsers: ${{ steps.config.outputs.browsers }}
      can_run: ${{ steps.config.outputs.can_run }}
    steps:
      - name: Configure test environment
        id: config
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENV="${{ github.event.inputs.environment }}"
            BROWSERS="${{ github.event.inputs.browsers }}"
          else
            ENV="staging"
            BROWSERS="all"
          fi

          # Set base URL
          if [ "$ENV" == "staging" ]; then
            BASE_URL="https://staging.trackmyshuttle.com"
            CAN_RUN="${{ needs.check-secrets.outputs.staging_configured }}"
          else
            BASE_URL="https://preproduction.trackmyshuttle.com"
            CAN_RUN="${{ needs.check-secrets.outputs.preprod_configured }}"
          fi

          # Set browser matrix
          if [ "$BROWSERS" == "all" ]; then
            BROWSER_JSON='["chromium", "firefox", "webkit"]'
          else
            BROWSER_JSON="[\"$BROWSERS\"]"
          fi

          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "base_url=$BASE_URL" >> $GITHUB_OUTPUT
          echo "browsers=$BROWSER_JSON" >> $GITHUB_OUTPUT
          echo "can_run=$CAN_RUN" >> $GITHUB_OUTPUT

          echo "üìã Environment: $ENV"
          echo "üåê Base URL: $BASE_URL"
          echo "üñ•Ô∏è Browsers: $BROWSER_JSON"

  full-suite-tests:
    name: Full Suite - ${{ matrix.browser }}
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.can_run == 'true'
    timeout-minutes: 120

    strategy:
      fail-fast: false
      matrix:
        browser: ${{ fromJson(needs.setup.outputs.browsers) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps ${{ matrix.browser }}

      - name: Create .env.local from secrets
        run: |
          ENV="${{ needs.setup.outputs.environment }}"
          if [ "$ENV" == "staging" ]; then
            cat > .env.local << EOF
          STAGING_MANAGER_EMAIL=${{ secrets.STAGING_MANAGER_EMAIL }}
          STAGING_MANAGER_PASSWORD=${{ secrets.STAGING_MANAGER_PASSWORD }}
          STAGING_OPERATOR_EMAIL=${{ secrets.STAGING_OPERATOR_EMAIL }}
          STAGING_OPERATOR_PASSWORD=${{ secrets.STAGING_OPERATOR_PASSWORD }}
          EOF
          else
            cat > .env.local << EOF
          STAGING_MANAGER_EMAIL=${{ secrets.PREPROD_MANAGER_EMAIL }}
          STAGING_MANAGER_PASSWORD=${{ secrets.PREPROD_MANAGER_PASSWORD }}
          STAGING_OPERATOR_EMAIL=${{ secrets.PREPROD_OPERATOR_EMAIL }}
          STAGING_OPERATOR_PASSWORD=${{ secrets.PREPROD_OPERATOR_PASSWORD }}
          EOF
          fi

      - name: Run Playwright tests
        run: |
          TEST_SUITE="${{ github.event.inputs.test_suite || 'all' }}"

          CMD="npx playwright test --project=${{ matrix.browser }}"

          if [ "$TEST_SUITE" != "all" ]; then
            CMD="$CMD tests/$TEST_SUITE/"
          fi

          echo "Running: $CMD"
          eval $CMD
        env:
          CI: true
          ENV: ${{ needs.setup.outputs.environment }}
          BASE_URL: ${{ needs.setup.outputs.base_url }}

      - name: Upload test report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: full-suite-${{ matrix.browser }}-${{ github.run_number }}
          path: playwright-report/
          retention-days: 30

      - name: Upload failure artifacts
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: failures-${{ matrix.browser }}-${{ github.run_number }}
          path: test-results/
          retention-days: 7

  # Summary job
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [setup, full-suite-tests]
    if: always() && needs.setup.outputs.can_run == 'true'
    steps:
      - name: Generate summary
        run: |
          echo "## Full Suite Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Browser | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY

          RESULT="${{ needs.full-suite-tests.result }}"
          if [ "$RESULT" == "success" ]; then
            echo "| All Browsers | ‚úÖ Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Some Browsers | ‚ùå Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ needs.setup.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Base URL:** ${{ needs.setup.outputs.base_url }}" >> $GITHUB_STEP_SUMMARY

      - name: Check results
        run: |
          if [ "${{ needs.full-suite-tests.result }}" == "failure" ]; then
            echo "‚ùå Some tests failed!"
            exit 1
          else
            echo "‚úÖ All tests passed!"
          fi

  # Notification
  notify:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: [setup, full-suite-tests]
    if: always() && needs.setup.outputs.can_run == 'true'
    steps:
      - name: Send notification
        if: ${{ secrets.SLACK_WEBHOOK_URL != '' }}
        run: |
          RESULT="${{ needs.full-suite-tests.result }}"
          if [ "$RESULT" == "success" ]; then
            EMOJI="‚úÖ"
            TEXT="Full Suite Tests Passed"
          else
            EMOJI="‚ùå"
            TEXT="Full Suite Tests Failed"
          fi

          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"text\": \"$EMOJI $TEXT\",
              \"blocks\": [
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"$EMOJI *$TEXT*\n\n*Environment:* ${{ needs.setup.outputs.environment }}\n*Browsers:* Multi-browser\n*Run:* <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Details>\"
                  }
                }
              ]
            }" \
            ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true

  # Skip notification
  notify-skipped:
    name: Notify Skipped
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.can_run == 'false'
    steps:
      - name: Log skip reason
        run: |
          echo "‚è≠Ô∏è Full suite tests skipped - secrets not configured for ${{ needs.setup.outputs.environment }}"
