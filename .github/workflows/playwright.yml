name: Playwright Tests
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test'
        required: false
        default: 'staging'
        type: choice
        options:
          - staging
          - preproduction
          - production
      test_type:
        description: 'Test type to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - smoke
          - regression
          - critical

permissions:
  contents: read
  checks: write
  pull-requests: write

env:
  CI: true
  NODE_ENV: test
  PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 0

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write
      pull-requests: write
    outputs:
      test_result: ${{ steps.test-status.outputs.result }}
      total_tests: ${{ steps.parse-results.outputs.total }}
      passed_tests: ${{ steps.parse-results.outputs.passed }}
      failed_tests: ${{ steps.parse-results.outputs.failed }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install Playwright browsers
        run: npx playwright install --with-deps
      
      - name: Determine environment
        id: env
        run: |
          ENV="${{ github.event.inputs.environment || 'staging' }}"
          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "Testing against: $ENV"
      
      - name: Run Playwright tests
        env:
          ENV: ${{ steps.env.outputs.environment }}
          BASE_URL: ${{ secrets[format('BASE_URL_{0}', steps.env.outputs.environment)] }}
          STAGING_MANAGER_EMAIL: ${{ secrets.STAGING_MANAGER_EMAIL }}
          STAGING_MANAGER_PASSWORD: ${{ secrets.STAGING_MANAGER_PASSWORD }}
          STAGING_OPERATOR_EMAIL: ${{ secrets.STAGING_OPERATOR_EMAIL }}
          STAGING_OPERATOR_PASSWORD: ${{ secrets.STAGING_OPERATOR_PASSWORD }}
          PREPRODUCTION_MANAGER_EMAIL: ${{ secrets.PREPRODUCTION_MANAGER_EMAIL }}
          PREPRODUCTION_MANAGER_PASSWORD: ${{ secrets.PREPRODUCTION_MANAGER_PASSWORD }}
          PREPRODUCTION_OPERATOR_EMAIL: ${{ secrets.PREPRODUCTION_OPERATOR_EMAIL }}
          PREPRODUCTION_OPERATOR_PASSWORD: ${{ secrets.PREPRODUCTION_OPERATOR_PASSWORD }}
          PROD_MANAGER_EMAIL: ${{ secrets.PROD_MANAGER_EMAIL }}
          PROD_MANAGER_PASSWORD: ${{ secrets.PROD_MANAGER_PASSWORD }}
          PROD_OPERATOR_EMAIL: ${{ secrets.PROD_OPERATOR_EMAIL }}
          PROD_OPERATOR_PASSWORD: ${{ secrets.PROD_OPERATOR_PASSWORD }}
        run: npx playwright test
      
      - name: Determine test status
        id: test-status
        if: always()
        run: |
          if [ ${{ job.status }} == "success" ]; then
            echo "result=success" >> $GITHUB_OUTPUT
          else
            echo "result=failure" >> $GITHUB_OUTPUT
          fi
      
      - name: Parse test results
        id: parse-results
        if: always()
        run: |
          if [ -f "test-results.json" ]; then
            TOTAL=$(jq '.stats.expected + .stats.unexpected // 0' test-results.json 2>/dev/null || echo "0")
            PASSED=$(jq '.stats.expected // 0' test-results.json 2>/dev/null || echo "0")
            FAILED=$(jq '.stats.unexpected // 0' test-results.json 2>/dev/null || echo "0")
          else
            TOTAL="N/A"
            PASSED="N/A"
            FAILED="N/A"
          fi
          
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
      
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-${{ steps.env.outputs.environment }}
          path: playwright-report/
          retention-days: 30
      
      - name: Upload test results JSON
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-json-${{ steps.env.outputs.environment }}
          path: test-results.json
          retention-days: 30
      
      - name: Publish test results
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: results.xml
          check_name: Playwright Test Results
          comment_mode: always
          github_token: ${{ secrets.GITHUB_TOKEN }}

  notify:
    name: Send Slack Notification
    runs-on: ubuntu-latest
    needs: [test]
    if: always()
    permissions:
      contents: read
    steps:
      - name: Send Slack notification
        run: |
          # Skip if webhook URL is not configured
          if [ -z "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            echo "Slack webhook not configured, skipping notification"
            exit 0
          fi
          
          RESULT="${{ needs.test.result }}"
          ENV="${{ github.event.inputs.environment || 'staging' }}"
          TEST_TYPE="${{ github.event.inputs.test_type || 'all' }}"
          TOTAL="${{ needs.test.outputs.total_tests }}"
          PASSED="${{ needs.test.outputs.passed_tests }}"
          FAILED="${{ needs.test.outputs.failed_tests }}"
          
          if [ "$RESULT" == "success" ]; then
            EMOJI="✅"
            COLOR="#36a64f"
            HEADER="Playwright Tests Passed"
          else
            EMOJI="❌"
            COLOR="#dc3545"
            HEADER="Playwright Tests Failed"
          fi
          
          curl -X POST \
            -H 'Content-type: application/json' \
            --data "{
              \"attachments\": [
                {
                  \"color\": \"$COLOR\",
                  \"blocks\": [
                    {
                      \"type\": \"header\",
                      \"text\": {
                        \"type\": \"plain_text\",
                        \"text\": \"$EMOJI $HEADER\",
                        \"emoji\": true
                      }
                    },
                    {
                      \"type\": \"section\",
                      \"fields\": [
                        {
                          \"type\": \"mrkdwn\",
                          \"text\": \"*Environment:*\n$ENV\"
                        },
                        {
                          \"type\": \"mrkdwn\",
                          \"text\": \"*Test Type:*\n$TEST_TYPE\"
                        },
                        {
                          \"type\": \"mrkdwn\",
                          \"text\": \"*Total Tests:*\n$TOTAL\"
                        },
                        {
                          \"type\": \"mrkdwn\",
                          \"text\": \"*Passed:*\n$PASSED\"
                        },
                        {
                          \"type\": \"mrkdwn\",
                          \"text\": \"*Failed:*\n$FAILED\"
                        },
                        {
                          \"type\": \"mrkdwn\",
                          \"text\": \"*Branch:*\n${{ github.ref_name }}\"
                        }
                      ]
                    },
                    {
                      \"type\": \"actions\",
                      \"elements\": [
                        {
                          \"type\": \"button\",
                          \"text\": {
                            \"type\": \"plain_text\",
                            \"text\": \"View Results\",
                            \"emoji\": true
                          },
                          \"url\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"
                        }
                      ]
                    }
                  ]
                }
              ]
            }" \
            ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true
