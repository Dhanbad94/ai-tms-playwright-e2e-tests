name: Scheduled Tests - Production

# Schedule:
# - Smoke tests Friday at 10:00 AM UTC (Production health check)
# - Regression tests Sunday at 6:00 AM UTC (Weekend validation)

# ‚ö†Ô∏è PRODUCTION SAFETY NOTES:
# - Only smoke and read-only tests should run
# - Avoid CRUD operations that modify production data
# - Tests should be non-destructive
# - Failures trigger critical alerts

on:
  schedule:
    # Friday at 10:00 AM UTC - Smoke tests
    - cron: '0 10 * * 5'
    # Sunday at 6:00 AM UTC - Regression tests
    - cron: '0 6 * * 0'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Test type to run'
        required: true
        default: 'smoke'
        type: choice
        options:
          - smoke
          - regression
          - critical
      test_suite:
        description: 'Test suite to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - ASAPSettings
          - TMSOnboarding
      confirm_production:
        description: 'Type "CONFIRM" to run on production'
        required: true
        default: ''
        type: string

env:
  ENV: production
  BASE_URL: https://trackmyshuttle.com

jobs:
  # Check if secrets are configured
  check-secrets:
    name: Verify Production Secrets
    runs-on: ubuntu-latest
    outputs:
      secrets_configured: ${{ steps.check.outputs.configured }}
      slack_configured: ${{ steps.check.outputs.slack }}
    steps:
      - name: Check if production secrets exist
        id: check
        run: |
          if [ -n "${{ secrets.PROD_MANAGER_EMAIL }}" ] && [ -n "${{ secrets.PROD_MANAGER_PASSWORD }}" ]; then
            echo "configured=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Production secrets are configured"
          else
            echo "configured=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Production secrets not configured - skipping tests"
          fi

          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            echo "slack=true" >> $GITHUB_OUTPUT
          else
            echo "slack=false" >> $GITHUB_OUTPUT
          fi

  # Safety check for manual runs
  safety-check:
    name: Production Safety Check
    runs-on: ubuntu-latest
    needs: check-secrets
    if: needs.check-secrets.outputs.secrets_configured == 'true'
    outputs:
      proceed: ${{ steps.verify.outputs.proceed }}
    steps:
      - name: Verify manual trigger confirmation
        id: verify
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            if [ "${{ github.event.inputs.confirm_production }}" != "CONFIRM" ]; then
              echo "‚ùå Manual production runs require confirmation"
              echo "Please type 'CONFIRM' in the confirmation field"
              echo "proceed=false" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi
          echo "proceed=true" >> $GITHUB_OUTPUT
          echo "‚úÖ Safety check passed"

  production-tests:
    name: Production ${{ github.event.inputs.test_type || 'Scheduled' }} Tests
    runs-on: ubuntu-latest
    needs: [check-secrets, safety-check]
    if: |
      needs.check-secrets.outputs.secrets_configured == 'true' &&
      needs.safety-check.outputs.proceed == 'true'
    timeout-minutes: 45
    outputs:
      test_type: ${{ steps.test-config.outputs.test_type }}
      test_suite: ${{ steps.test-config.outputs.test_suite }}
      total_tests: ${{ steps.test-result.outputs.total }}
      passed_tests: ${{ steps.test-result.outputs.passed }}
      failed_tests: ${{ steps.test-result.outputs.failed }}
      duration: ${{ steps.test-result.outputs.duration }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Create .env.local from secrets
        run: |
          cat > .env.local << EOF
          STAGING_MANAGER_EMAIL=${{ secrets.PROD_MANAGER_EMAIL }}
          STAGING_MANAGER_PASSWORD=${{ secrets.PROD_MANAGER_PASSWORD }}
          STAGING_OPERATOR_EMAIL=${{ secrets.PROD_OPERATOR_EMAIL }}
          STAGING_OPERATOR_PASSWORD=${{ secrets.PROD_OPERATOR_PASSWORD }}
          EOF

      - name: Determine test configuration
        id: test-config
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TEST_TYPE="${{ github.event.inputs.test_type }}"
            TEST_SUITE="${{ github.event.inputs.test_suite }}"
          else
            # Determine based on schedule
            DAY=$(date -u +%u)
            if [ "$DAY" == "5" ]; then
              TEST_TYPE="smoke"
            else
              TEST_TYPE="regression"
            fi
            TEST_SUITE="all"
          fi

          echo "test_type=$TEST_TYPE" >> $GITHUB_OUTPUT
          echo "test_suite=$TEST_SUITE" >> $GITHUB_OUTPUT
          echo "üö® PRODUCTION Environment"
          echo "üìã Test Type: $TEST_TYPE"
          echo "üìÅ Test Suite: $TEST_SUITE"

      - name: Run Playwright tests
        id: run-tests
        run: |
          TEST_TYPE="${{ steps.test-config.outputs.test_type }}"
          TEST_SUITE="${{ steps.test-config.outputs.test_suite }}"

          CMD="npx playwright test --project=chromium"

          if [ "$TEST_TYPE" != "all" ]; then
            CMD="$CMD --grep @$TEST_TYPE"
          fi

          if [ "$TEST_SUITE" != "all" ]; then
            CMD="$CMD tests/$TEST_SUITE/"
          fi

          echo "üö® Running on PRODUCTION: $CMD"
          START_TIME=$(date +%s)

          set +e
          eval $CMD
          EXIT_CODE=$?
          set -e

          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "duration=$DURATION" >> $GITHUB_OUTPUT
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT

          exit $EXIT_CODE
        env:
          CI: true
          ENV: production
          BASE_URL: https://trackmyshuttle.com

      - name: Parse test results
        id: test-result
        if: always()
        run: |
          if [ -f "test-results.json" ]; then
            TOTAL=$(jq '.stats.expected + .stats.unexpected + .stats.flaky // 0' test-results.json 2>/dev/null || echo "0")
            PASSED=$(jq '.stats.expected // 0' test-results.json 2>/dev/null || echo "0")
            FAILED=$(jq '.stats.unexpected // 0' test-results.json 2>/dev/null || echo "0")
            DURATION=$(jq '.stats.duration // 0' test-results.json 2>/dev/null || echo "0")
            DURATION_SEC=$((DURATION / 1000))
          else
            TOTAL="N/A"
            PASSED="N/A"
            FAILED="N/A"
            DURATION_SEC="${{ steps.run-tests.outputs.duration }}"
          fi

          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "duration=${DURATION_SEC}s" >> $GITHUB_OUTPUT

      - name: Upload test report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: production-report-${{ steps.test-config.outputs.test_type }}-${{ github.run_number }}
          path: playwright-report/
          retention-days: 30

      - name: Upload failure artifacts
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: production-failures-${{ github.run_number }}
          path: test-results/
          retention-days: 14

  # Unified notification job for production
  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: [check-secrets, safety-check, production-tests]
    if: always() && needs.check-secrets.outputs.secrets_configured == 'true' && needs.safety-check.outputs.proceed == 'true' && needs.check-secrets.outputs.slack_configured == 'true'
    steps:
      - name: Send Slack notification
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          RESULT="${{ needs.production-tests.result }}"
          TEST_TYPE="${{ needs.production-tests.outputs.test_type }}"
          TOTAL="${{ needs.production-tests.outputs.total_tests }}"
          PASSED="${{ needs.production-tests.outputs.passed_tests }}"
          FAILED="${{ needs.production-tests.outputs.failed_tests }}"
          DURATION="${{ needs.production-tests.outputs.duration }}"

          if [ "$RESULT" == "success" ]; then
            EMOJI="‚úÖ"
            COLOR="#36a64f"
            HEADER="Production Tests Passed"
            EXTRA_MSG="\n\n‚úÖ Production health check OK!"
          else
            EMOJI="üö®"
            COLOR="#dc3545"
            HEADER="CRITICAL: Production Tests Failed"
            EXTRA_MSG="\n\nüö® *IMMEDIATE ATTENTION REQUIRED!*"
          fi

          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"attachments\": [
                {
                  \"color\": \"$COLOR\",
                  \"blocks\": [
                    {
                      \"type\": \"header\",
                      \"text\": {
                        \"type\": \"plain_text\",
                        \"text\": \"$EMOJI $HEADER\",
                        \"emoji\": true
                      }
                    },
                    {
                      \"type\": \"section\",
                      \"fields\": [
                        {
                          \"type\": \"mrkdwn\",
                          \"text\": \"*Environment:*\nüö® PRODUCTION\"
                        },
                        {
                          \"type\": \"mrkdwn\",
                          \"text\": \"*Test Type:*\n${TEST_TYPE}\"
                        },
                        {
                          \"type\": \"mrkdwn\",
                          \"text\": \"*Total Tests:*\n${TOTAL}\"
                        },
                        {
                          \"type\": \"mrkdwn\",
                          \"text\": \"*Passed:*\n${PASSED}\"
                        },
                        {
                          \"type\": \"mrkdwn\",
                          \"text\": \"*Failed:*\n${FAILED}\"
                        },
                        {
                          \"type\": \"mrkdwn\",
                          \"text\": \"*Duration:*\n${DURATION}\"
                        }
                      ]
                    },
                    {
                      \"type\": \"section\",
                      \"text\": {
                        \"type\": \"mrkdwn\",
                        \"text\": \"*Repository:* ${{ github.repository }}\n*Branch:* ${{ github.ref_name }}${EXTRA_MSG}\"
                      }
                    },
                    {
                      \"type\": \"actions\",
                      \"elements\": [
                        {
                          \"type\": \"button\",
                          \"text\": {
                            \"type\": \"plain_text\",
                            \"text\": \"View Results\",
                            \"emoji\": true
                          },
                          \"url\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"
                        }
                      ]
                    }
                  ]
                }
              ]
            }" \
            $SLACK_WEBHOOK_URL
        continue-on-error: true

  # Skip notification when secrets not configured
  notify-skipped:
    name: Notify Skipped
    runs-on: ubuntu-latest
    needs: check-secrets
    if: needs.check-secrets.outputs.secrets_configured == 'false'
    steps:
      - name: Log skip reason
        run: |
          echo "‚è≠Ô∏è Production tests skipped - secrets not configured"
          echo "To enable, add these GitHub Secrets:"
          echo "  - PROD_MANAGER_EMAIL"
          echo "  - PROD_MANAGER_PASSWORD"
          echo "  - PROD_OPERATOR_EMAIL"
          echo "  - PROD_OPERATOR_PASSWORD"
